name: Build and Run Image

on:
  workflow_dispatch:
  push:
    branches: main

env:
  DOCKER_IMAGE_NAME: "node-app-project"

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Dockerfile
        run: docker build -t $DOCKER_IMAGE_NAME:${{ github.sha }} .

      - name: Start minikube
        uses: medyagh/setup-minikube@latest

      - name: Load image to minikube
        run: |
          minikube image ls
          minikube image load $DOCKER_IMAGE_NAME:${{ github.sha }}
          echo "Loaded image"
          minikube image ls

      - name: Run using kubectl command
        run: |
          IMAGE_NAME="$DOCKER_IMAGE_NAME:${{ github.sha }}"
          sed -i "s/node-app:1.0/$IMAGE_NAME/" deployment.yaml
          kubectl apply -f deployment.yaml
          sleep 20
          kubectl get all
          kubectl describe pod $(kubectl get pod --selector app=node-app -o=jsonpath='{.items[0].metadata.name}{"\n"}')
          echo "-------------------------------------------------------------------------"
          kubectl logs $(kubectl get pod --selector app=node-app -o=jsonpath='{.items[0].metadata.name}{"\n"}')
